<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounting Data Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.9/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-beautiful-dnd@13.1.1/dist/react-beautiful-dnd.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
        }

        /* Light mode colors (kept for functionality, but template is dark) */
        .light {
            background-color: #f8fafc; /* Tailwind gray-50 */
            color: #1e293b; /* Tailwind slate-800 */
        }
        .light .bg-container { background-color: #ffffff; } /* White */
        .light .text-primary { color: #0f172a; } /* Tailwind slate-900 */
        .light .text-secondary { color: #475569; } /* Tailwind slate-600 */
        .light .text-accent { color: #2563eb; } /* Tailwind blue-600 */
        .light .border-primary { border-color: #e2e8f0; } /* Tailwind slate-200 */
        .light .border-secondary { border-color: #cbd5e1; } /* Tailwind slate-300 */
        .light .bg-accent-light { background-color: #eff6ff; } /* Tailwind blue-50 */
        .light .text-accent-dark { color: #1e40af; } /* Tailwind blue-800 */
        .light .button-primary { background-color: #2563eb; color: white; }
        .light .button-primary:hover { background-color: #1d4ed8; }
        .light .button-secondary { background-color: #e2e8f0; color: #475569; }
        .light .button-secondary:hover { background-color: #cbd5e1; }
        .light .table-header-bg { background-color: #f1f5f9; } /* slate-100 */
        .light .table-row-hover:hover { background-color: #f8fafc; } /* slate-50 */
        .light .input-field { border-color: #cbd5e1; background-color: #ffffff; color: #1e293b; }
        .light .modal-bg { background-color: rgba(100, 116, 139, 0.75); }
        .light .anomaly-row { background-color: #fee2e2; } /* Tailwind red-100 */
        .light .anomaly-row:hover { background-color: #fecaca; } /* Tailwind red-200 */
        .light .hero-bg { background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); }
        .light .card-bg { background-color: #ffffff; }
        .light .header-bg { background-color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .light .footer-bg { background-color: #1e293b; color: #e2e8f0;} /* slate-800 */
        .light .footer-link { color: #94a3b8; } /* slate-400 */
        .light .footer-link:hover { color: #e2e8f0; } /* slate-200 */


        /* Dark mode colors - Styled to match template */
        .dark {
            background-color: #0B0F19; /* Very dark blue/purple, adjust as needed */
            color: #cbd5e1; /* Tailwind slate-300 */
        }
        .dark .bg-container { background-color: #1E293B; } /* Dark slate, card backgrounds */
        .dark .text-primary { color: #f8fafc; } /* Tailwind slate-50 */
        .dark .text-secondary { color: #94a3b8; } /* Tailwind slate-400 */
        .dark .text-accent { color: #7c3aed; } /* Purple accent from template */
        .dark .border-primary { border-color: #334155; } /* Tailwind slate-700 */
        .dark .border-secondary { border-color: #475569; } /* Tailwind slate-600 */

        .dark .bg-accent-light { background-color: #1e293b; } /* Darker version of blue-50 */
        .dark .text-accent-dark { color: #a78bfa; } /* Lighter Purple for text on dark */

        .dark .button-primary { background-color: #7c3aed; color: white; } /* Purple button */
        .dark .button-primary:hover { background-color: #6d28d9; }
        .dark .button-secondary { background-color: #334155; color: #e2e8f0; } /* Slate button */
        .dark .button-secondary:hover { background-color: #475569; }

        .dark .table-header-bg { background-color: #1e293b; } /* Dark slate for table header */
        .dark .table-row-hover:hover { background-color: #28354a; } /* Slightly lighter dark slate */
        .dark .input-field { border-color: #475569; background-color: #0f172a; color: #e2e8f0; } /* Dark input */
        .dark .input-field::placeholder { color: #64748b; } /* slate-500 */
        .dark .modal-bg { background-color: rgba(11, 15, 25, 0.8); } /* Darker modal backdrop */
        .dark .anomaly-row { background-color: #5f2727; } /* Dark red for anomaly */
        .dark .anomaly-row:hover { background-color: #7f2a2a; }

        .dark .hero-bg {
            background-color: #0F172A; /* Fallback */
            /* Simplified gradient based on template's feel */
            background: linear-gradient(135deg, #1e3a8a 0%, #3b0764 100%);
        }
        .dark .card-bg { background-color: #161E2D; } /* Slightly different card bg for depth */
        .dark .header-bg { background-color: #0F172A; border-bottom: 1px solid #1E293B; }
        .dark .footer-bg { background-color: #020617; color: #94a3b8;} /* Even darker footer, slate-950 */
        .dark .footer-link { color: #64748b; } /* slate-500 */
        .dark .footer-link:hover { color: #94a3b8; } /* slate-400 */

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .shadow-modern {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .dark .shadow-modern {
             box-shadow: 0 0 15px rgba(124, 58, 237, 0.1), 0 0 5px rgba(124, 58, 237, 0.05);
        }

        .shadow-modern-hover:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
         .dark .shadow-modern-hover:hover {
            box-shadow: 0 0 25px rgba(124, 58, 237, 0.2), 0 0 10px rgba(124, 58, 237, 0.1);
            transform: translateY(-2px);
        }
        .transition-all-ease {
            transition: all 0.3s ease-in-out;
        }

        /* Custom scrollbar for dark theme */
        .dark ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .dark ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
            border-radius: 10px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 10px;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        .file-input-button::file-selector-button {
            /* Tailwind classes don't work directly here, so custom style if needed */
        }
        .dark .file-input-button::file-selector-button {
            background-color: #374151; /* gray-700 */
            color: #e5e7eb; /* gray-200 */
            border: 1px solid #4b5563; /* gray-600 */
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 600; /* font-semibold */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .dark .file-input-button::file-selector-button:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .hero-decorative-circle {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            position: absolute;
            opacity: 0.3;
            filter: blur(50px);
        }
    </style>
</head>

<body class="min-h-screen antialiased">
    <div id="root"></div>

    <script type="text/babel">
        function App() {
            const [csvData, setCsvData] = React.useState([]);
            const [extractedText, setExtractedText] = React.useState('');
            const [status, setStatus] = React.useState('Upload a CSV/Excel file and a PDF or OCR text file, then click Start.');
            const [isProcessing, setIsProcessing] = React.useState(false);
            const [progress, setProgress] = React.useState(0);
            const [csvOrExcelFile, setCsvOrExcelFile] = React.useState(null);
            const [pdfFile, setPdfFile] = React.useState(null);
            const [ocrTextFile, setOcrTextFile, ] = React.useState(null);
            const [outputFormat, setOutputFormat] = React.useState('csv');
            const [showExtractedText, setShowExtractedText] = React.useState(false);
            const [inferredHeaders, setInferredHeaders] = React.useState({ date: 'Transaction Date', description: 'Description', amount: 'Total', category: 'category' });
            const [editMode, setEditMode] = React.useState(false);
            const [editedData, setEditedData] = React.useState([]);
            const [showAuthModal, setShowAuthModal] = React.useState(false);
            const [authMode, setAuthMode] = React.useState('login');
            const [authUsername, setAuthUsername] = React.useState('');
            const [authPassword, setAuthPassword] = React.useState('');
            const [authError, setAuthError] = React.useState('');
            const [user, setUser] = React.useState(null);
            const [theme, setTheme] = React.useState('dark'); // Default to dark
            const [ocrLanguage, setOcrLanguage] = React.useState('eng');

            React.useEffect(() => {
                const html = document.documentElement;
                if (theme === 'dark') {
                    html.classList.add('dark');
                    html.classList.remove('light');
                } else {
                    html.classList.remove('dark');
                    html.classList.add('light');
                }
                localStorage.setItem('theme', theme);
            }, [theme]);

            const toggleTheme = () => {
                setTheme(prevTheme => prevTheme === 'light' ? 'dark' : 'light');
            };

            const allColumns = [
                { key: 'Date', label: 'Date', tooltip: 'Date the expense was incurred.' },
                { key: 'Vendor', label: 'Vendor/Merchant', tooltip: 'Who the expense was paid to.' },
                { key: 'Description', label: 'Description/Memo', tooltip: 'Brief note on what the charge was for.' },
                { key: 'Category', label: 'Category', tooltip: 'High-level classification (Travel, Supplies, etc.)' },
                { key: 'GLCode', label: 'GL/Account Code', tooltip: 'User\'s chart-of-accounts code.' },
                { key: 'AmountNet', label: 'Amount (Net)', tooltip: 'Expense amount before tax.' },
                { key: 'TaxAmount', label: 'Tax Amount', tooltip: 'Sales tax, VAT, GST.' },
                { key: 'TotalAmount', label: 'Total Amount', tooltip: 'Gross amount (net + tax).' },
                { key: 'Currency', label: 'Currency', tooltip: 'Currency of the transaction.' },
                { key: 'PaymentMethod', label: 'Payment Method', tooltip: 'e.g. Credit Card, Cash, ACH, PayPal.' },
                { key: 'ReceiptNumber', label: 'Receipt/Invoice #', tooltip: 'Reference for audit or matching.' },
                { key: 'IsAnomaly', label: 'Anomaly?', tooltip: 'Indicates if the transaction is flagged as unusual.' },
                { key: 'AnomalyReason', label: 'Anomaly Reason', tooltip: 'Explanation for why the transaction was flagged.' },
            ];

            const [visibleColumns, setVisibleColumns] = React.useState([]);

            React.useEffect(() => {
                if (csvData.length > 0) {
                    let initialVisibleKeys = Object.keys(csvData[0]);
                    if (!user) {
                        initialVisibleKeys = initialVisibleKeys.filter(key => 
                            key !== 'GLCode' && key !== 'IsAnomaly' && key !== 'AnomalyReason'
                        );
                    }
                    setVisibleColumns(initialVisibleKeys);
                } else {
                     const defaultCols = ['Date', 'Vendor', 'Description', 'Category', 'TotalAmount'];
                     setVisibleColumns(defaultCols);
                }
            }, [csvData, user]);


            const handleToggleColumn = (colKey) => {
                setVisibleColumns(prev => {
                    if (prev.includes(colKey)) {
                        return prev.filter(k => k !== colKey);
                    } else {
                        // Maintain order from allColumns
                        const newVisible = [...prev, colKey];
                        return allColumns.map(c => c.key).filter(k => newVisible.includes(k));
                    }
                });
            };

            React.useEffect(() => {
                setEditedData(csvData);
            }, [csvData]);

            const handleCellChange = (rowIdx, colName, value) => {
                setEditedData(prev =>
                    prev.map((row, idx) =>
                        idx === rowIdx ? { ...row, [colName]: value } : row
                    )
                );
            };

            const handleEdit = () => setEditMode(true);
            const handleDone = () => {
                setEditMode(false);
                setCsvData(editedData);
                 setStatus('Changes saved. Download the updated file.');
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (['csv', 'xlsx', 'xls'].includes(fileExtension)) {
                    setCsvOrExcelFile(file);
                    setStatus((pdfFile || ocrTextFile) ? 'Files ready. Click Start.' : 'CSV/Excel uploaded. Add a PDF/text file.');
                } else {
                    setStatus('Please upload a valid CSV or Excel file.');
                }
            };

            const handlePDFUpload = (e) => {
                const file = e.target.files[0];
                if (file && (file.type === 'application/pdf' || file.type === 'text/plain')) {
                    if (file.type === 'application/pdf') {
                        setPdfFile(file);
                        setOcrTextFile(null);
                    } else {
                        setOcrTextFile(file);
                        setPdfFile(null);
                    }
                    setStatus(csvOrExcelFile ? 'Files ready. Click Start.' : 'PDF/text file uploaded. Add a CSV/Excel file.');
                } else {
                    setStatus('Please upload a valid PDF or text file.');
                }
            };

            const handleStart = async () => {
                if (!csvOrExcelFile || (!pdfFile && !ocrTextFile)) {
                    setStatus('Please upload both a CSV/Excel file and a PDF/text file.');
                    return;
                }
                setIsProcessing(true);
                setProgress(0);
                setStatus('Processing files...');
                let currentProgress = 0;
                const progressInterval = setInterval(() => {
                    currentProgress += 10;
                    if (currentProgress >= 90) clearInterval(progressInterval);
                    setProgress(currentProgress);
                }, 200);

                try {
                    const formData = new FormData();
                    formData.append('excel', csvOrExcelFile);
                    if (pdfFile) formData.append('pdf', pdfFile);
                    if (ocrTextFile) formData.append('pdf', ocrTextFile);
                    formData.append('ocr_language', ocrLanguage);

                    const response = await fetch('https://accounting-data-pro-2.onrender.com/parse', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error('Failed to process files. Ensure receipt has a table.');
                    
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);

                    setCsvData(data.rows);
                    setInferredHeaders(data.headers);
                    setExtractedText(data.extracted_text || '');
                    setProgress(100);
                    setStatus('Processing complete! View results below.');
                } catch (error) {
                    setStatus('Error: ' + error.message);
                    setProgress(0);
                } finally {
                    clearInterval(progressInterval);
                    setIsProcessing(false);
                }
            };

            const downloadFile = () => {
                if (csvData.length === 0) {
                    setStatus('No data to download.');
                    return;
                }
                const dataToDownload = editMode ? editedData : csvData;
                const headers = visibleColumns;

                if (outputFormat === 'csv') {
                    const csvContent = [
                        headers.join(','),
                        ...dataToDownload.map(row => headers.map(h => `"${row[h] || ''}"`).join(','))
                    ].join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'completed_accounting_data.csv';
                    a.click();
                    URL.revokeObjectURL(url);
                } else {
                    const worksheetData = dataToDownload.map(row => {
                        let newRow = {};
                        headers.forEach(h => { newRow[h] = row[h]; });
                        return newRow;
                    });
                    const worksheet = XLSX.utils.json_to_sheet(worksheetData, { header: headers });
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Data');
                    XLSX.writeFile(workbook, 'completed_accounting_data.xlsx');
                }
                setStatus(`File downloaded successfully as ${outputFormat.toUpperCase()}!`);
            };

            const { DragDropContext, Droppable, Draggable } = window.ReactBeautifulDnd;

            const handleDragEnd = (result) => {
                if (!result.destination) return;
                const reordered = Array.from(visibleColumns);
                const [removed] = reordered.splice(result.source.index, 1);
                reordered.splice(result.destination.index, 0, removed);
                setVisibleColumns(reordered);
            };

            const handleNavbarLogin = (e) => {
                e.preventDefault();
                setShowAuthModal(true);
                setAuthMode('login');
                setAuthError('');
            };
            
            const handleLogout = () => {
                localStorage.removeItem('jwt');
                setUser(null);
                setCsvData([]);
                setEditedData([]);
                setExtractedText('');
                setStatus('Logged out. Upload files to start.');
            };

            const handleAuthSubmit = async (e) => {
                e.preventDefault();
                setAuthError('');
                const endpoint = authMode === 'login' ? '/login' : '/register';
                try {
                    const res = await fetch(`https://accounting-data-pro-2.onrender.com${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: authUsername, password: authPassword })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Unknown error');
                    if (authMode === 'login') {
                        localStorage.setItem('jwt', data.access_token);
                        setUser(authUsername);
                        setShowAuthModal(false);
                        setStatus('Logged in. Upload files to start.');
                    } else {
                        setAuthMode('login');
                        setAuthError('Signup successful! Please log in.');
                    }
                } catch (err) {
                    setAuthError(err.message);
                }
            };

            window.handleGoogleSignIn = (response) => {
                setUser('Google User');
                setShowAuthModal(false);
                localStorage.setItem('jwt', response.credential);
                setStatus('Logged in with Google. Upload files to start.');
            };

            React.useEffect(() => {
                if (showAuthModal && window.google) {
                    const googleButtonDiv = document.getElementById('google-signin-btn');
                    if (googleButtonDiv && !googleButtonDiv.hasChildNodes()) {
                        window.google.accounts.id.initialize({
                            client_id: '1372632578-25ps13f0r0goiqh31nnke4hsrvrap9tm.apps.googleusercontent.com',
                            callback: window.handleGoogleSignIn
                        });
                        window.google.accounts.id.renderButton(
                            googleButtonDiv,
                            { theme: theme === 'dark' ? 'filled_black' : 'outline', size: 'large', width: '100%' }
                        );
                    }
                }
            }, [showAuthModal, theme]);
            
            const scrollToUpload = () => {
                document.getElementById('upload-area')?.scrollIntoView({ behavior: 'smooth' });
            };

            return (
                <div className={`min-h-screen flex flex-col ${theme}`}>
                    <header className="header-bg sticky top-0 z-40">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex items-center justify-between h-16">
                                <div className="flex items-center">
                                    <svg className="h-8 w-8 text-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    <h1 className="ml-3 text-2xl font-bold text-primary">Accounting Data Pro</h1>
                                </div>
                                <nav className="flex items-center space-x-3">
                                    <button
                                        onClick={toggleTheme}
                                        className="p-2 rounded-full text-secondary hover:text-primary hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
                                        title={theme === 'light' ? 'Switch to Dark Mode' : 'Switch to Light Mode'}
                                    >
                                        {theme === 'light' ? (
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                                        ) : (
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h1M3 12H2m8.042-8.67L9.252 5.253M14.748 18.747l.708.708M7.354 5.646L6.646 4.938M16.646 17.062l.708.708M12 7a5 5 0 100 10 5 5 0 000-10z"></path></svg>
                                        )}
                                    </button>
                                    {user ? (
                                        <div className="flex items-center space-x-3">
                                            <span className="text-secondary text-sm font-medium hidden sm:block">Welcome, {user}!</span>
                                            <button onClick={handleLogout} className="px-3 py-1.5 text-sm font-medium text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 border border-red-500 dark:border-red-400 rounded-md hover:bg-red-50 dark:hover:bg-red-900/30 transition-colors">Logout</button>
                                        </div>
                                    ) : (
                                        <button onClick={handleNavbarLogin} className="px-4 py-2 text-sm font-semibold button-primary rounded-md hover:opacity-90 transition-opacity shadow-sm">Login</button>
                                    )}
                                </nav>
                            </div>
                        </div>
                    </header>
                    <section className="hero-bg text-primary py-20 md:py-32 relative overflow-hidden">
                        <div className="hero-decorative-circle bg-purple-600 top-[-50px] left-[-100px]"></div>
                        <div className="hero-decorative-circle bg-sky-500 bottom-[-100px] right-[-50px] w-[400px] h-[400px]"></div>
                        <div className="max-w-4xl mx-auto px-6 text-center relative z-10">
                            <h2 className="text-4xl sm:text-5xl md:text-6xl font-extrabold mb-6 animate-fade-in leading-tight">
                                Complete Your <span className="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">Accounting Data</span> Effortlessly
                            </h2>
                            <p className="text-lg md:text-xl text-slate-300 dark:text-slate-300 max-w-2xl mx-auto mb-10 animate-fade-in" style={{animationDelay: '0.2s'}}>
                                Upload your CSV/Excel and a PDF/OCR text file. Our AI intelligently detects headers, fills missing fields, and provides a clean, downloadable output.
                            </p>
                            <button onClick={scrollToUpload} className="button-primary text-lg font-semibold px-10 py-4 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all-ease animate-fade-in" style={{animationDelay: '0.4s'}}>
                                START NOW
                            </button>
                        </div>
                    </section>
                    <main id="upload-area" className="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-12">
                        <h3 className="text-3xl font-bold text-primary mb-10 text-center">Upload & Process</h3>
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                            <div className="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="card-bg p-6 rounded-xl shadow-modern transition-all-ease border border-primary">
                                    <div className="flex items-center space-x-3 mb-4 text-accent">
                                        <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                        <h3 className="text-xl font-semibold text-primary">1. Upload CSV or Excel</h3>
                                    </div>
                                    <input type="file" accept=".csv,.xlsx,.xls" onChange={handleFileUpload} className="file-input-button block w-full text-sm text-secondary" />
                                    <p className="text-xs text-secondary mt-2">{csvOrExcelFile ? `Selected: ${csvOrExcelFile.name}` : "Upload an empty file or one with existing data."}</p>
                                </div>
                                <div className="card-bg p-6 rounded-xl shadow-modern transition-all-ease border border-primary">
                                    <div className="flex items-center space-x-3 mb-4 text-accent">
                                        <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"></path></svg>
                                        <h3 className="text-xl font-semibold text-primary">2. Upload PDF or Text</h3>
                                    </div>
                                    <input type="file" accept=".pdf,.txt" onChange={handlePDFUpload} className="file-input-button block w-full text-sm text-secondary" />
                                    <p className="text-xs text-secondary mt-2">{pdfFile ? `Selected: ${pdfFile.name}` : ocrTextFile ? `Selected: ${ocrTextFile.name}` : "Use a PDF or plain text file."}</p>
                                    <div className="mt-4">
                                        <label htmlFor="ocrLanguage" className="block text-sm font-medium text-secondary mb-1">OCR Language:</label>
                                        <select id="ocrLanguage" value={ocrLanguage} onChange={(e) => setOcrLanguage(e.target.value)} className="input-field border-secondary rounded-md px-3 py-2 w-full text-sm focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-purple-500">
                                            <option value="eng">English</option>
                                            <option value="spa">Spanish</option>
                                            <option value="fra">French</option>
                                            <option value="deu">German</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div className="lg:col-span-1 card-bg p-6 rounded-xl shadow-modern border border-primary">
                                <div className="flex items-center space-x-3 mb-4 text-accent">
                                    <svg className="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                                    <h3 className="text-xl font-semibold text-primary">3. Start Processing</h3>
                                </div>
                                <div className="text-center mb-4">
                                    {isProcessing ? (
                                        <div className="relative w-24 h-24 mx-auto">
                                            <svg className="w-full h-full" viewBox="0 0 100 100">
                                                <circle className="text-slate-700" strokeWidth="8" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
                                                <circle className="text-purple-500" strokeWidth="8" strokeDasharray="251.2" strokeDashoffset={`calc(251.2 - (251.2 * ${progress}) / 100)`} strokeLinecap="round" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" style={{transition: 'stroke-dashoffset 0.3s ease'}}/>
                                            </svg>
                                            <div className="absolute inset-0 flex items-center justify-center text-xl font-semibold text-primary">{progress}%</div>
                                        </div>
                                    ) : (
                                        <div className="p-6 bg-slate-700/30 rounded-full inline-block border-2 border-purple-500/50">
                                            <svg className="w-12 h-12 text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M10.125 2.25h-4.5c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125v-9M10.125 2.25h.375a9 9 0 019 9v.375M10.125 2.25A3.375 3.375 0 0113.5 5.625v1.5c0 .621.504 1.125 1.125 1.125h1.5a3.375 3.375 0 013.375 3.375M9 15l2.25 2.25L15 12" /></svg>
                                        </div>
                                    )}
                                </div>
                                <p className={`text-sm ${status.includes('Error') ? 'text-red-400' : 'text-secondary'} mb-4 text-center min-h-[40px]`}>{status}</p>
                                <button onClick={handleStart} disabled={isProcessing || !csvOrExcelFile || (!pdfFile && !ocrTextFile)} className={`w-full py-3 px-4 rounded-lg font-semibold flex items-center justify-center space-x-2 button-primary transition-all-ease ${isProcessing || !csvOrExcelFile || (!pdfFile && !ocrTextFile) ? 'opacity-50 cursor-not-allowed' : 'hover:opacity-90'}`}>
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                    <span>{isProcessing ? 'Processing...' : 'Start Processing'}</span>
                                </button>
                                {extractedText && <button onClick={() => setShowExtractedText(!showExtractedText)} className="mt-3 w-full text-sm text-purple-400 hover:text-purple-300 transition-colors underline">{showExtractedText ? 'Hide Extracted Text' : 'Show Extracted Text'}</button>}
                                {user && <button onClick={handleRetrainModel} className="mt-4 w-full py-2.5 px-4 rounded-lg font-semibold flex items-center justify-center space-x-2 bg-indigo-600 text-white hover:bg-indigo-700 transition-all-ease shadow-sm"><svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg><span>Retrain AI Model</span></button>}
                                {showExtractedText && extractedText && <div className="mt-4 p-3 bg-slate-800 rounded-lg border border-secondary animate-fade-in max-h-40 overflow-y-auto"><h4 className="text-sm font-semibold text-purple-300 mb-2">Extracted Text:</h4><pre className="text-xs text-slate-300 whitespace-pre-wrap font-mono">{extractedText}</pre></div>}
                            </div>
                        </div>
                        {csvData.length > 0 && (
                            <div className="mt-16 card-bg p-6 rounded-xl shadow-modern animate-fade-in border border-primary" style={{animationDelay: '0.4s'}}>
                                <div className="flex items-center justify-between mb-6 pb-3 border-b border-secondary">
                                    <div className="flex items-center space-x-3 text-accent">
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                        <h3 className="text-xl font-semibold text-primary">Processed Data Table</h3>
                                    </div>
                                    <div className="space-x-2">
                                        {!editMode ? (
                                            <button onClick={handleEdit} className="px-4 py-2 button-secondary rounded-md hover:opacity-90 transition-opacity text-sm">Edit Data</button>
                                        ) : (
                                            <button onClick={handleDone} className="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors text-sm">Save Changes</button>
                                        )}
                                    </div>
                                </div>
                                <DragDropContext onDragEnd={handleDragEnd}>
                                    <Droppable droppableId="columns" direction="horizontal">
                                        {(provided) => (
                                            <div className="mb-4 flex flex-wrap items-center gap-2 p-3 bg-slate-800 rounded-lg border border-secondary" ref={provided.innerRef} {...provided.droppableProps}>
                                                {visibleColumns.map((colKey, idx) => {
                                                    const col = allColumns.find(c => c.key === colKey) || { label: colKey, tooltip: '' };
                                                    return (
                                                        <Draggable key={colKey} draggableId={colKey} index={idx}>
                                                            {(provided, snapshot) => (
                                                                <div ref={provided.innerRef} {...provided.draggableProps} {...provided.dragHandleProps} className={`flex items-center space-x-1.5 text-xs bg-slate-700 border border-slate-600 text-slate-200 rounded-full px-3 py-1.5 shadow-sm cursor-grab active:cursor-grabbing transition-all-ease ${snapshot.isDragging ? 'bg-purple-600 ring-2 ring-purple-400' : ''}`} style={{ ...provided.draggableProps.style }}>
                                                                    <span title={col.tooltip} className="font-medium">{col.label}</span>
                                                                    <button onClick={() => handleToggleColumn(colKey)} className="text-slate-400 hover:text-red-400 transition-colors" title="Remove column"><svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd"></path></svg></button>
                                                                </div>
                                                            )}
                                                        </Draggable>
                                                    );
                                                })}
                                                {provided.placeholder}
                                                <div className="ml-auto">
                                                    <select onChange={e => { if (e.target.value) { handleToggleColumn(e.target.value); e.target.value = ''; }}} className="input-field border-secondary rounded-full px-3 py-1.5 text-xs bg-slate-700 text-slate-300 focus:ring-purple-500 focus:border-purple-500 shadow-sm cursor-pointer appearance-none" defaultValue="">
                                                        <option value="" disabled>+ Add column</option>
                                                        {allColumns.filter(col => !visibleColumns.includes(col.key) && (user || (col.key !== 'GLCode' && col.key !== 'IsAnomaly' && col.key !== 'AnomalyReason'))).map(col => (<option key={col.key} value={col.key}>{col.label}</option>))}
                                                    </select>
                                                </div>
                                            </div>
                                        )}
                                    </Droppable>
                                </DragDropContext>
                                <div className="overflow-x-auto border border-secondary rounded-lg shadow-sm">
                                    <table className="min-w-full text-sm text-left text-primary">
                                        <thead className="table-header-bg">
                                            <tr>
                                                {visibleColumns.map(colKey => {
                                                    const col = allColumns.find(c => c.key === colKey) || { label: colKey, tooltip: '' };
                                                    return (<th key={colKey} title={col.tooltip} className="p-3 font-semibold text-purple-300 whitespace-nowrap">{col.label}</th>);
                                                })}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(editMode ? editedData : csvData).map((row, rowIdx) => (
                                                <tr key={rowIdx} className={`border-b border-secondary table-row-hover transition-colors duration-150 ${row.IsAnomaly === 'True' ? 'anomaly-row' : ''}`}>
                                                    {visibleColumns.map(colKey => (
                                                        <td key={colKey} className="p-3 align-top text-slate-300">
                                                            {editMode && colKey !== 'IsAnomaly' && colKey !== 'AnomalyReason' ? (
                                                                <input value={row[colKey] || ""} onChange={e => handleCellChange(rowIdx, colKey, e.target.value)} className="input-field border-secondary rounded-md px-2 py-1 w-full text-sm focus:outline-none focus:ring-1 focus:ring-purple-500" />
                                                            ) : (
                                                                <span className="block max-w-[200px] overflow-hidden text-ellipsis whitespace-nowrap" title={row[colKey]}>{row[colKey]}</span>
                                                            )}
                                                        </td>
                                                    ))}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="mt-6 flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0 sm:space-x-4">
                                    <div className="flex items-center space-x-4">
                                        <label className="flex items-center cursor-pointer text-secondary">
                                            <input type="radio" name="outputFormat" value="csv" checked={outputFormat === 'csv'} onChange={() => setOutputFormat('csv')} className="form-radio h-4 w-4 text-purple-500 border-slate-600 bg-slate-700 focus:ring-purple-500" />
                                            <span className="ml-2 text-sm font-medium">CSV</span>
                                        </label>
                                        <label className="flex items-center cursor-pointer text-secondary">
                                            <input type="radio" name="outputFormat" value="excel" checked={outputFormat === 'excel'} onChange={() => setOutputFormat('excel')} className="form-radio h-4 w-4 text-purple-500 border-slate-600 bg-slate-700 focus:ring-purple-500" />
                                            <span className="ml-2 text-sm font-medium">Excel</span>
                                        </label>
                                    </div>
                                    <button onClick={downloadFile} className="flex items-center space-x-2 px-6 py-3 rounded-lg button-primary shadow-md hover:opacity-90">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                        <span>Download {outputFormat === 'csv' ? 'CSV' : 'Excel'}</span>
                                    </button>
                                </div>
                            </div>
                        )}
                    </main>
                    <footer className="footer-bg py-10 mt-16">
                        <div className="max-w-7xl mx-auto px-6 flex flex-col md:flex-row justify-between items-center text-center md:text-left">
                            <p className="text-sm">&copy; {new Date().getFullYear()} Accounting Data Pro. All rights reserved.</p>
                            <div className="mt-4 md:mt-0 space-x-6">
                                <a href="#" className="footer-link text-sm transition-colors">About</a>
                                <a href="#" className="footer-link text-sm transition-colors">Support</a>
                                <a href="#" className="footer-link text-sm transition-colors">Privacy Policy</a>
                            </div>
                        </div>
                    </footer>
                    {showAuthModal && (
                        <div className="fixed inset-0 modal-bg overflow-y-auto h-full w-full flex justify-center items-center z-50 animate-fade-in p-4">
                            <div className="relative p-8 bg-container w-full max-w-md mx-auto rounded-xl shadow-2xl transform transition-transform duration-300 scale-100 animate-fade-in" style={{animationDelay: '0.1s'}}>
                                <h3 className="text-3xl font-bold mb-6 text-center text-primary">{authMode === 'login' ? 'Welcome Back!' : 'Create Account'}</h3>
                                {authError && <p className="bg-red-500/20 text-red-300 border border-red-500/30 rounded-md p-3 mb-4 text-sm text-center">{authError}</p>}
                                <form onSubmit={handleAuthSubmit} className="space-y-6">
                                    <div>
                                        <label htmlFor="username-auth" className="block text-sm font-medium text-secondary mb-1">Username</label>
                                        <input type="text" id="username-auth" className="input-field block w-full px-4 py-2.5 border-secondary rounded-lg shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 text-base" value={authUsername} onChange={(e) => setAuthUsername(e.target.value)} required placeholder="Enter your username" />
                                    </div>
                                    <div>
                                        <label htmlFor="password-auth" className="block text-sm font-medium text-secondary mb-1">Password</label>
                                        <input type="password" id="password-auth" className="input-field block w-full px-4 py-2.5 border-secondary rounded-lg shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 text-base" value={authPassword} onChange={(e) => setAuthPassword(e.target.value)} required placeholder="Enter your password" />
                                    </div>
                                    <button type="submit" className="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-semibold text-white button-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-purple-500 transition-all-ease">
                                        {authMode === 'login' ? 'Login to your Account' : 'Sign Up for Free'}
                                    </button>
                                </form>
                                <div className="mt-6 text-center">
                                    <button onClick={() => {setAuthMode(authMode === 'login' ? 'signup' : 'login'); setAuthError('');}} className="text-sm text-purple-400 hover:text-purple-300 font-medium underline">
                                        {authMode === 'login' ? 'New here? Create an account' : 'Already have an account? Log In'}
                                    </button>
                                </div>
                                <div className="mt-6 border-t border-secondary pt-6">
                                    <div id="google-signin-btn" className="flex justify-center [&>div]:w-full"></div>
                                </div>
                                <button onClick={() => setShowAuthModal(false)} className="absolute top-5 right-5 text-slate-500 hover:text-slate-300 transition-colors" aria-label="Close modal">
                                    <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
"

